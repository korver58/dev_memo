FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    git curl wget zip unzip \
    python3 python3-pip \
    jq xsltproc libclang1 \
    && rm -rf /var/lib/apt/lists/*

# install latest Doxygen
ARG DOXYGEN_VER=1.13.2
ARG DOXYGEN_RELEASE=1_13_2
RUN cd /tmp \
    && wget https://github.com/doxygen/doxygen/releases/download/Release_${DOXYGEN_RELEASE}/doxygen-${DOXYGEN_VER}.linux.bin.tar.gz \
    && tar -zxf doxygen-${DOXYGEN_VER}.linux.bin.tar.gz \
    && cp doxygen-${DOXYGEN_VER}/bin/doxygen /usr/local/bin \
    && rm -rf doxygen-*

# install latest cloc
ARG CLOC_VER=2.04
RUN cd /tmp \
    && wget https://github.com/AlDanial/cloc/releases/download/v${CLOC_VER}/cloc-${CLOC_VER}.tar.gz \
    && tar -zxf cloc-${CLOC_VER}.tar.gz \
    && cp cloc-${CLOC_VER}/cloc /usr/local/bin \
    && rm -rf cloc-*

# install latest Graphviz
# https://graphviz.org/download/source/
ARG GRAPHVIZ_VER=12.2.1
RUN cd /tmp \
    && wget https://gitlab.com/api/v4/projects/4207231/packages/generic/graphviz-releases/${GRAPHVIZ_VER}/graphviz-${GRAPHVIZ_VER}.tar.gz \
    && tar -zxf graphviz-${GRAPHVIZ_VER}.tar.gz \
    && cd graphviz-${GRAPHVIZ_VER} \
    && ./configure \
    && make \
    && make install \
    && cd .. \
    && rm -rf graphviz-*

# ARG UID=1001
# ARG USER=developer
# RUN useradd -m -u ${UID} ${USER}

USER ubuntu
WORKDIR /home/ubuntu
COPY --chown=ubuntu requirements.txt ./requirements.txt
RUN python3 -m pip install --upgrade pip --break-system-packages \
    && python3 -m pip install --no-cache-dir -r requirements.txt --break-system-packages

CMD ["/bin/bash"]
